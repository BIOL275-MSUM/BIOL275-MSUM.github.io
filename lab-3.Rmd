# Introduction to ggplot2

## Objectives

Learn to:

-   Load ggplot2 and other tidyverse packages

-   Understand the layered grammar of graphics:

    -   Create a blank plot using the `ggplot()` function
    -   Add geometric objects using the `geom_*()` family of functions
    -   Define an aesthetic mapping for a project using the `aes()` function
    -   Apply a statistical transformation using the `stat_*()` family of functions
    -   Add labels to a ggplot using the `labs()` function

-   Create a graph showing the distribution of a single variable

    -   Create a bar chart for a categorical variable using the `geom_col()` and `geom_bar()` functions
    -   Arrange the categories in a bar chart by frequency
    -   Create a histogram for a numerical variable using the `geom_histogram()` function
    -   Choose and set appropriate histogram bin widths

-   Set the image width for an R Markdown code chunk

## Introduction

This lab will introduce you to visualizing data using ggplot2.

R has other systems for creating graphs, such as the plotting functions included with base R. At times you may end up searching online for help with you R code. Be sure to add ggplot to any of your search terms so that you end up finding solutions that fit within the requirements of this course.

The instructions below correspond to sections 1, 2, 3, and 6 in the [Data visualisation](https://r4ds.had.co.nz/data-visualisation.html "3 Data visualisation | R for Data Science") chapter of your lab manual, *R for Data Science*. If the steps below do not make sense on their own, please read those sections.

## Project Setup

For this lab you will work in a new RStudio Project under git version control. Here are the steps you should follow to set up your Project:

1.  Claim your repository

    a.  Go to the course D2L page

    b.  Find the Content module for this lab

    c.  Follow the link to claim your repository (repo) on GitHub

        *Note: this link will not appear until the day of your lab. If you want to get ahead, you can always try reading the [Data visualisation](https://r4ds.had.co.nz/data-visualisation.html "3 Data visualisation | R for Data Science") chapter ahead of time*

    d.  Copy the URL for your newly created repository

2.  Create a new project

    a.  Open RStudio
    b.  Click **New Project...** on the File menu or Project menu (upper right)
    c.  In the dialog window, select Version Control and then Git
    d.  Paste the URL for your repo
    e.  Hit tab to autofill the Directory name field. If it does not autofill, then type in the name of your repository as best you can (include the word "lab", the lab number, and your name)
    f.  Click the Browse button and find a good place on your hard drive for this project to live
    g.  Set your Project options. When the project opens, go to Tools \> Project Options... and change the first three drop down menus to "No" (see [Project Options](project-options.html) for detailed instructions and rationale)

3.  Create a new script

    a.  Click the New File button (upper left) or go to File \> New File

    b.  Select "R script"

    c.  Immediately save your script with a useful name, for example `tutorial-walk-through.R`

For the rest of the lab, you will copying code from this website and paste it into your R script. *Only later, after you have a working R script, will you copy anything into your lab report R Markdown document.*

## Load packages

ggplot2 is one of the core packages in the tidyverse. In the code below, you will load the ggplot2 package and other tidyverse packages. Before you do, get your script off to a nice start by adding a code section. Code sections keep your code organized and makes it easy to jump to specific code sections without scrolling. In a long script, this can be a real time saver. The [Code Sections](code-sections.html) chapter has more details, but for now you can just follow these instructions:

1.  Go to **Code \> Insert Section...** or use the keyboard shortcut Ctrl+Shift+I / Cmd+Shift+I
2.  Type "load packages" in the dialog window and click the **OK** button

As you work through the tutorials, add other code headings as necessary.

Load the tidyverse package by adding this code below the new code section and running it:

```{r show-library-tidyverse, eval=FALSE}
library(tidyverse)
```

That line of code ***loads*** the tidyverse package and the eight core packages within the tidyverse, one of which is ggplot2. The vast majority of your data science needs can be met with those eight packages. While it is possible to load each package individually, for example `library(ggplot2)`, it's usually better to load the tidyverse package because its not often that you only want to use one of the packages in the tidyverse.

When you run the code, you will see a ***message*** in the console like this:

```{r run-library-tidyverse, echo=FALSE}
library(tidyverse)
```

The first part tells you which packages are being loaded. You will notice ggplot2 is on that list. The second part of the message tells you which tidyverse functions conflict with (and override) other functions. Usually those other functions are from base R, but they could also be functions from other packages you had already loaded. If you ever want to use a package that has been overridden with another package, you have to refer to it explicitly by its package *and* function name.

## Show data for a categorical variable

### Example: tiger data

We will use the data from Example 2.2A in your textbook for this activity. The summary from the textbook is as follows:

> Conflict between humans and tigers threatens tiger populations, kills people, and reduces public support for conservation. Gurung et al. (2008) investigated causes of human deaths by tigers near the protected area of Chitwan National Park, Nepal. Eighty-eight people were killed by 36 individual tigers between 1979 and 2006, mainly within 1 km of the park edge. Table 2.2-1 lists the main activities of people at the time they were killed. Such information may be helpful to identify activities that increase vulnerability to attack.

The dataset consists of one table showing the activities of 88 people at the time they were attacked and killed by tigers near Chitwan National Park, Nepal, from 1979 to 2006.

You can view and explore the data using this interactive table:

```{r tiger-data-table, echo=FALSE, message=FALSE, warning=FALSE, class.ouput='p-3'}
library(DT)
DT::datatable(
  read_csv("https://whitlockschluter.zoology.ubc.ca/wp-content/data/chapter02/chap02e2aDeathsFromTigers.csv"),
  options = list(pageLength = 5)
)
```

*Note: This interactive table was actually created in R using the [htmlwidgets](https://www.htmlwidgets.org/showcase_datatables.html) package. In a future lab you will learn how to make a table like this.*

### Read the tiger data

The next step in your R script is to read the data into R.

First, create a new [code section](code-section.html) named "deaths from tigers"

The data for this and other examples from your textbook can be found on the [book website](https://whitlockschluter.zoology.ubc.ca/). It is stored as a comma-separated values file (.csv).

Read the data from the textbook website using the `read_csv()` function, part of the readr package, and assign it to an object named `tiger_data` using the left assignment operator `<-` :

```{r}
tiger_data <- read_csv("https://whitlockschluter.zoology.ubc.ca/wp-content/data/chapter02/chap02e2aDeathsFromTigers.csv")
```

The message you get in your console tells you how the data in the CSV was parsed (interpretted) when it was read into R. You can ignore it for now.

### View the tiger data

You will notice that the data itself did not appear in the console. That's because we assigned it to an object but did not print it. To print the data in the console, type the name of the object into your R script and run it:

```{r}
tiger_data
```

Notice that the output in the console indicates the object is a tibble (a tidyverse name for a table of data) with 88 observations (rows) and 2 variables (columns).

Each row represents a sample unit, or person. Thus the sample size is 88.

The variables are:

-   **person**. a number from 1 to 88 identifying which person the data pertains to. While this variable contains a number, it is incorrect to call it a numeric variable. The number was not measured, and it cannot have mathematical functions applied to it such as calculating the mean. The value is really no different than a person's name, which would consist of text. Therefore it is best to consider person a *categorical* variable.

-   **activity**. the person's activity at the time they were attacked and killed. This is a *categorical* variable with a discrete number of possible values.

For our purposes, the only variable of interest is activity. We will not use the person variable.

You can view a list of distinct values taken by a categorical variable by using the `distinct()` function, which returns a table of distinct values taken by the variable. The first argument to the function is the name of the data, the second argument is the name of the variable:

```{r eval=FALSE}
distinct(tiger_data, activity)
```

```{r echo=FALSE}
distinct(tiger_data, activity) %>% 
  print(n = Inf)
```

### Contingency table

If you want to see how many times each value of activity occurs in the data, you can create a contingency table using the `count()` function. Again, the data object is the first argument and the variable name is the second argument.

```{r}
count(tiger_data, activity)
```

As you can see, this function returns another tibble that has two variables: the original one *activity* and a new one *n*, which represents the number of times the variable occurred in the data.

### Make a bar graph

The distribution of a single categorical variable is best visualized using bar graph (also called a bar chart, barchart, or column graph). In this section, you will learn how to create a bar graph.

ggplot uses a layered approach to building a graph. You will learn more about what this means as you build your first graph using the tiger data. Your goal is to create a bar graph similar to the one in the textbook in Figure 2.2-1, which looks like this:

![](images/whitlock_2.2-1.jpg){width="400"}

The first step is to create a new ggplot using the `ggplot()` function. The first (and for now, only) argument is the data argument. You should set it to the data object you created above. Now run the code:

```{r}
ggplot(data = tiger_data)
```

When you plot something in RStudio (i.e. when you create a graph), it will appear in the Plots tab in the lower right pane.

Look at the Plots tab. What do you see? At first you may think it is a blank screen, but actually it is a gray box representing the empty plot. At this point, R knows you want to plot the tiger data, but it doesn't know which variables to plot or how to display the data.

To display the data, we need to add a geometric object. In this case, because we want a bar graph, we will use the `geom_bar()` function. You add the geometric object to the canvas using a plus sign like this:

```{r}
ggplot(data = tiger_data) +
  geom_bar(mapping = aes(x = activity))
```

The first (and for now, only) argument to `geom_bar()` is `mapping`, an aesthetic mapping that tells R which variables in the data table *map* to which parts of the graph. An aesthetic mapping is defined by the `aes()` function. `geom_bar()` requires only one aesthetic, the argument `x`, which tells R which variable to put on the x axis. We want to put the *activity* variable on the x axis, so we set `x = activity` . Put this all together, and the way to add a bars to the graph is `geom_bar(mapping = aes(x = activity)`

The result figure, shown above, should look similar to the one in Figure 2.2-1 of your textbook. With a couple of notable exceptions.

First, the x-axis tick labels may overlap each other, depending on how large your monitor is when you plot this graph. We can fix that by using the `theme()` function to change an element of the plot's theme called `axis.text.x`. The `angle` argument sets the angle of rotation, and the `hjust` argument sets the horizontal alignment, with 0 being left aligned, 1 being right aligned, and 0.5 being centered text. The `theme()` layer is added to the existing ggplot code using a `+` sign.

```{r}
ggplot(data = tiger_data) +
  geom_bar(mapping = aes(x = activity)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Second, the levels (categories) of activity should be arranged in descending order by count (i.e. big columns on the left). We can do that with a little bit of wizardry from the forcats package, one of the core packages in the tidyverse that was loaded when you loaded the tidyverse package. The `fct_infreq()` function changes a variable to factor with the levels defined by how frequently they occur in the data.

```{r}
ggplot(data = tiger_data) +
  geom_bar(mapping = aes(x = fct_infreq(activity))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

The `forcats::` preceding the function name is just a way of telling R which package the function is in. It's not necessary here, because we already loaded the forcats package, but it serves as a visual reminder to anyone reading the code that it requires the forcats package.

Third, the figure in the textbook features red columns and larger text. This is accomplished by adding a `fill` argument to `geom_bar()` and setting the font-size using the `theme_gray()` function:

```{r, fig.width=5.56, fig.height=5.62}
ggplot(data = tiger_data) +
  geom_bar(mapping = aes(x = fct_infreq(activity)), fill = "darkred") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_gray(base_size = 13)
```

Finally, the axis labels could be improved. Axis labels should start with capital letters and, for numeric variables, should include the units of measurement in parentheses. We can set axis labels with `labs()`. The argument `x =` means set the x axis label to the following text, while `y =` means set the y axis label to the following text. The label text itself should appear in quotation marks.

We can also make the axis labels bold by changing the `axis.title` element using the `theme()` function. Both of these changes are incorporated below:

```{r}
ggplot(data = tiger_data) +
  geom_bar(mapping = aes(x = fct_infreq(activity)), fill = "darkred") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(face = "bold")) +
  labs(x = "Activity", y = "Frequency (number of people)")
```

Compare your figure to the original above.

Not bad!

This one, however, can be inserted into any document at any size and resolution. And most importantly, your code documents how you created the graph, ensuring the figure could be reproduced by anyone.

## Show data for a continuous variable

### Get the data

### Use geom_histogram() for raw data

### Use stat_identity for summarized data

## Your assignment

1.  Open the R script titled `lab-assignment-script.R`
2.  Follow the directions to create an R script that produces the requested figures

## Your lab report

1.  Open the R script titled `lab-assignment-script.R`
2.  Your instructor has seeded your repository with an R Markdown document for your lab report, titled lab-report.Rmd. Open this file
3.  Update the YAML header with your name
4.  Copy the code for the requested figures into the appropriate R code chunks
5.  Add text to answer each questions. Make your text bold so it is easily readable.

## Grading Rubric

You will be assessed based on the following rubric:

-   GitHub Classroom repository claimed

-   R script

    -   Good organization

        -   Code sections make sense

        -   Code goes in correct order, e.g.

            -   load packages before using them
            -   read or load data before using it

    -   Has sufficient comments

        -   At top, explain purpose of the script
        -   Section headings throughout
        -   Each code chunk has a comment

    -   Code for plots works

-   R Markdown document

    -   Correct YAML header
    -   Good organization
    -   Sufficient explanatory text for each figure
    -   Questions answered correctly
    -   Answers marked in bold

-   Your lab report has been peer-reviewed at least once

-   Submitted link to repository on D2L
